openapi: 3.0.3
info:
  title: E-commerce Backend API
  description: |
    E-commerce backend API với hai backend độc lập (Node.js và PHP) kết nối đến cùng một database MySQL.
    
    **BẮT BUỘC sử dụng MySQL** - KHÔNG được thay thế bởi engine khác.
    
    ## Tính năng chính:
    - Đăng ký/Đăng nhập người dùng với JWT token (8 giờ)
    - Quản lý sản phẩm với phân trang và tìm kiếm
    - Tạo đơn hàng với validation tồn kho
    - Lịch sử đơn hàng theo user
    - UserID format: UID0000{n}
    
    ## Backend endpoints:
    - Node.js: `/api/node/`
    - PHP: `/api/php/`
  version: 1.0.0
  contact:
    name: Senior System Architect
    email: architect@example.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost/api/node
    description: Node.js Backend
  - url: http://localhost/api/php
    description: PHP Backend
  - url: http://localhost/api
    description: Load Balanced Gateway

tags:
  - name: Authentication
    description: User authentication endpoints
  - name: Products
    description: Product management endpoints
  - name: Orders
    description: Order management endpoints

paths:
  # Authentication endpoints
  /users/register:
    post:
      tags:
        - Authentication
      summary: Register new user
      description: Tạo tài khoản người dùng mới với user_code tự động
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  minLength: 6
                  example: password123
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: User registered successfully
                  data:
                    type: object
                    properties:
                      user:
                        type: object
                        properties:
                          id:
                            type: integer
                            example: 1
                          user_code:
                            type: string
                            example: UID00001
                          email:
                            type: string
                            example: user@example.com
                          created_at:
                            type: string
                            format: date-time
                      token:
                        type: string
                        example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'

  /users/login:
    post:
      tags:
        - Authentication
      summary: User login
      description: Đăng nhập người dùng và nhận JWT token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  example: password123
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Login successful
                  data:
                    type: object
                    properties:
                      user:
                        type: object
                        properties:
                          id:
                            type: integer
                            example: 1
                          user_code:
                            type: string
                            example: UID00001
                          email:
                            type: string
                            example: user@example.com
                          created_at:
                            type: string
                            format: date-time
                      token:
                        type: string
                        example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /users/change-password:
    put:
      tags:
        - Authentication
      summary: Change password
      description: Đổi mật khẩu người dùng
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - currentPassword
                - newPassword
              properties:
                currentPassword:
                  type: string
                  example: oldpassword123
                newPassword:
                  type: string
                  minLength: 6
                  example: newpassword123
      responses:
        '200':
          description: Password changed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Password changed successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /users/profile:
    get:
      tags:
        - Authentication
      summary: Get user profile
      description: Lấy thông tin profile người dùng
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Profile retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      id:
                        type: integer
                        example: 1
                      user_code:
                        type: string
                        example: UID00001
                      email:
                        type: string
                        example: user@example.com
                      created_at:
                        type: string
                        format: date-time
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  # Product endpoints
  /products:
    get:
      tags:
        - Products
      summary: Get products
      description: Lấy danh sách sản phẩm với phân trang và tìm kiếm
      parameters:
        - name: page
          in: query
          description: Page number
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          description: Items per page
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
        - name: search
          in: query
          description: Search by product name
          required: false
          schema:
            type: string
        - name: sortBy
          in: query
          description: Sort field
          required: false
          schema:
            type: string
            enum: [name, price, created_at]
            default: created_at
        - name: sortOrder
          in: query
          description: Sort order
          required: false
          schema:
            type: string
            enum: [ASC, DESC]
            default: DESC
      responses:
        '200':
          description: Products retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      products:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: integer
                              example: 1
                            name:
                              type: string
                              example: Áo thun nam
                            description:
                              type: string
                              example: Áo thun cotton 100% chất lượng cao
                            price:
                              type: number
                              format: decimal
                              example: 150000
                            stock:
                              type: integer
                              example: 100
                            image_url:
                              type: string
                              example: /images/ao-thun-nam.jpg
                            created_at:
                              type: string
                              format: date-time
                      pagination:
                        type: object
                        properties:
                          page:
                            type: integer
                            example: 1
                          limit:
                            type: integer
                            example: 10
                          total:
                            type: integer
                            example: 50
                          totalPages:
                            type: integer
                            example: 5

  /products/{id}:
    get:
      tags:
        - Products
      summary: Get product by ID
      description: Lấy thông tin chi tiết sản phẩm
      parameters:
        - name: id
          in: path
          required: true
          description: Product ID
          schema:
            type: integer
      responses:
        '200':
          description: Product retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      id:
                        type: integer
                        example: 1
                      name:
                        type: string
                        example: Áo thun nam
                      description:
                        type: string
                        example: Áo thun cotton 100% chất lượng cao
                      price:
                        type: number
                        format: decimal
                        example: 150000
                      stock:
                        type: integer
                        example: 100
                      image_url:
                        type: string
                        example: /images/ao-thun-nam.jpg
                      created_at:
                        type: string
                        format: date-time
        '404':
          $ref: '#/components/responses/NotFound'

  # Order endpoints
  /orders:
    post:
      tags:
        - Orders
      summary: Create order
      description: Tạo đơn hàng mới với validation tồn kho
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - items
              properties:
                items:
                  type: array
                  minItems: 1
                  items:
                    type: object
                    required:
                      - product_id
                      - quantity
                    properties:
                      product_id:
                        type: integer
                        example: 1
                      quantity:
                        type: integer
                        minimum: 1
                        example: 2
      responses:
        '201':
          description: Order created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Order created successfully
                  data:
                    type: object
                    properties:
                      id:
                        type: integer
                        example: 1
                      user_id:
                        type: integer
                        example: 1
                      total_amount:
                        type: number
                        format: decimal
                        example: 300000
                      status:
                        type: string
                        example: pending
                      created_at:
                        type: string
                        format: date-time
                      items:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: integer
                              example: 1
                            product_id:
                              type: integer
                              example: 1
                            quantity:
                              type: integer
                              example: 2
                            price:
                              type: number
                              format: decimal
                              example: 150000
                            product_name:
                              type: string
                              example: Áo thun nam
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /orders/history:
    get:
      tags:
        - Orders
      summary: Get order history
      description: Lấy lịch sử đơn hàng của người dùng
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          description: Page number
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          description: Items per page
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
      responses:
        '200':
          description: Order history retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      orders:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: integer
                              example: 1
                            user_id:
                              type: integer
                              example: 1
                            total_amount:
                              type: number
                              format: decimal
                              example: 300000
                            status:
                              type: string
                              example: pending
                            created_at:
                              type: string
                              format: date-time
                            items:
                              type: array
                              items:
                                type: object
                                properties:
                                  id:
                                    type: integer
                                    example: 1
                                  product_id:
                                    type: integer
                                    example: 1
                                  quantity:
                                    type: integer
                                    example: 2
                                  price:
                                    type: number
                                    format: decimal
                                    example: 150000
                                  product_name:
                                    type: string
                                    example: Áo thun nam
                      pagination:
                        type: object
                        properties:
                          page:
                            type: integer
                            example: 1
                          limit:
                            type: integer
                            example: 10
                          total:
                            type: integer
                            example: 5
                          totalPages:
                            type: integer
                            example: 1
        '401':
          $ref: '#/components/responses/Unauthorized'

  /orders/{id}:
    get:
      tags:
        - Orders
      summary: Get order by ID
      description: Lấy thông tin chi tiết đơn hàng
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Order ID
          schema:
            type: integer
      responses:
        '200':
          description: Order retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      id:
                        type: integer
                        example: 1
                      user_id:
                        type: integer
                        example: 1
                      total_amount:
                        type: number
                        format: decimal
                        example: 300000
                      status:
                        type: string
                        example: pending
                      created_at:
                        type: string
                        format: date-time
                      items:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: integer
                              example: 1
                            product_id:
                              type: integer
                              example: 1
                            quantity:
                              type: integer
                              example: 2
                            price:
                              type: number
                              format: decimal
                              example: 150000
                            product_name:
                              type: string
                              example: Áo thun nam
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token with 8 hours expiration

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: ERR_VALIDATION_FAILED
              message:
                type: string
                example: Validation failed

    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: ERR_INVALID_TOKEN
              message:
                type: string
                example: Invalid or expired token

    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: ERR_NOT_FOUND
              message:
                type: string
                example: Resource not found

    Conflict:
      description: Conflict
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: ERR_EMAIL_EXISTS
              message:
                type: string
                example: Email already exists

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: ERR_INTERNAL_SERVER_ERROR
              message:
                type: string
                example: Internal server error
